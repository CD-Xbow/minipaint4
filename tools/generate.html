<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Salai - ai image generation</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }
      #container {
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script>
      window.CALLAI_API_KEY = "sk-vibes-proxy-managed";
      window.CALLAI_CHAT_URL = "https://vibes-diy-api.com/";
      window.CALLAI_IMG_URL = "https://vibes-diy-api.com/";
    </script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@19.1.1/es2022/react.mjs",
          "react-dom": "https://esm.sh/react-dom@19.1.1/es2022/react-dom.mjs",
          "react-dom/client": "https://esm.sh/react-dom@19.1.1/es2022/client.mjs",
          "use-fireproof": "https://esm.sh/use-fireproof@0.23.11?external=react,react-dom",
          "call-ai": "https://esm.sh/call-ai",
          "use-vibes": "https://esm.sh/use-vibes",
          "three": "https://esm.sh/three"
        }
      }
    </script>
    <script type="text/babel" data-type="module">
      import ReactDOMClient from "react-dom/client";

      // prettier-ignore
      import React, { useState, useRef } from "react"
import { callAI } from "call-ai"
import { ImgGen } from "use-vibes"
import { useFireproof } from "use-fireproof"

export default function App() {
  const { database, useLiveQuery } = useFireproof("ImageGeneratorStudio")
  const [prompt, setPrompt] = useState("")
  const [selectedModel, setSelectedModel] = useState("fal-ai/flux/schnell")
  const [imageSize, setImageSize] = useState("square_hd")
  const [seed, setSeed] = useState("")
  const [enableSafety, setEnableSafety] = useState(true)
  const [numImages, setNumImages] = useState(1)
  const [isGenerating, setIsGenerating] = useState(false)
  const [currentImageId, setCurrentImageId] = useState(null)
  const [isDarkTheme, setIsDarkTheme] = useState(false)
  const [selectedStylePreset, setSelectedStylePreset] = useState("")
  const [copyStatus, setCopyStatus] = useState("")
  const canvasRef = useRef(null)
  const imageRef = useRef(null)

  // Query for generated images
  const { docs: imageDocuments } = useLiveQuery('type', {
    key: 'image',
    descending: true,
  })

  const models = [
    { id: "fal-ai/flux/schnell", name: "FLUX Schnell (Fast)", free: true },
    { id: "fal-ai/flux/dev", name: "FLUX Dev (Quality)", free: true },
    { id: "black-forest-labs/flux.1-schnell", name: "FLUX.1 Schnell", free: true },
    { id: "stabilityai/stable-diffusion-xl-base-1.0", name: "SDXL Base", free: true },
    { id: "runwayml/stable-diffusion-v1-5", name: "SD v1.5", free: true }
  ]

  const sizes = [
    { id: "square_hd", name: "Square HD (1024√ó1024)", ratio: "1:1" },
    { id: "square", name: "Square (512√ó512)", ratio: "1:1" },
    { id: "widescreen", name: "Widescreen (1600√ó900)", ratio: "16:9" },
    { id: "portrait_4_3", name: "Portrait 4:3 (768√ó1024)", ratio: "4:3" },
    { id: "portrait_16_9", name: "Portrait 16:9 (576√ó1024)", ratio: "16:9" },
    { id: "landscape_4_3", name: "Landscape 4:3 (1024√ó768)", ratio: "3:4" },
    { id: "landscape_16_9", name: "Landscape 16:9 (1024√ó576)", ratio: "9:16" }
  ]

  const stylePresets = [
    { id: "", name: "No Style", suffix: "" },
    { id: "photorealistic", name: "Photorealistic", suffix: ", photorealistic, high detail, sharp focus, professional photography" },
    { id: "portrait", name: "Portrait", suffix: ", professional portrait, studio lighting, 85mm lens, shallow depth of field" },
    { id: "landscape", name: "Landscape", suffix: ", landscape photography, golden hour lighting, wide angle, detailed" },
    { id: "artistic", name: "Artistic", suffix: ", artistic, fine art, creative composition, dramatic lighting" },
    { id: "vintage", name: "Vintage", suffix: ", vintage style, film grain, retro colors, classic aesthetic" },
    { id: "minimalist", name: "Minimalist", suffix: ", minimalist design, clean, simple, elegant, negative space" },
    { id: "watercolor", name: "Watercolor", suffix: ", watercolor painting, soft brushstrokes, flowing colors, artistic" },
    { id: "oil_painting", name: "Oil Painting", suffix: ", oil painting, thick brushstrokes, rich colors, classical art style" },
    { id: "digital_art", name: "Digital Art", suffix: ", digital art, concept art, detailed illustration, vibrant colors" },
    { id: "black_white", name: "Black & White", suffix: ", black and white, monochrome, high contrast, dramatic shadows" },
    { id: "cinematic", name: "Cinematic", suffix: ", cinematic lighting, movie still, dramatic composition, film aesthetic" }
  ]

  // Theme classes
  const theme = {
    bg: isDarkTheme ? 'bg-slate-900' : 'bg-gray-50',
    cardBg: isDarkTheme ? 'bg-slate-800' : 'bg-white',
    text: isDarkTheme ? 'text-gray-100' : 'text-gray-900',
    textSecondary: isDarkTheme ? 'text-gray-300' : 'text-gray-600',
    border: isDarkTheme ? 'border-slate-600' : 'border-gray-200',
    input: isDarkTheme ? 'bg-slate-700 border-slate-600 text-gray-100' : 'bg-white border-gray-300 text-gray-900',
    button: isDarkTheme ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-500 hover:bg-blue-600',
    buttonSecondary: isDarkTheme ? 'bg-slate-700 hover:bg-slate-600 text-gray-200' : 'bg-gray-200 hover:bg-gray-300 text-gray-800',
    shadow: isDarkTheme ? 'shadow-lg shadow-black/20' : 'shadow-lg'
  }

  const generateImage = async () => {
    if (!prompt.trim()) return
    
    setIsGenerating(true)
    try {
      const selectedPreset = stylePresets.find(preset => preset.id === selectedStylePreset)
      const finalPrompt = selectedPreset ? prompt.trim() + selectedPreset.suffix : prompt.trim()
      
      // Create document with generation parameters
      const doc = {
        type: "image",
        prompt: finalPrompt,
        originalPrompt: prompt.trim(),
        stylePreset: selectedStylePreset,
        model: selectedModel,
        size: imageSize,
        seed: seed || undefined,
        enableSafety,
        numImages,
        createdAt: new Date().toISOString(),
        status: "generating"
      }
      
      const savedDoc = await database.put(doc)
      setCurrentImageId(savedDoc._id)
      
    } catch (error) {
      console.error("Generation failed:", error)
    } finally {
      setIsGenerating(false)
    }
  }

  const getImageElement = () => {
    // Find the actual img element in the ImgGen component
    const imgGenContainer = document.querySelector(`[data-image-id="${currentImageId}"] img`)
    if (imgGenContainer) return imgGenContainer
    
    // Fallback: look for any img in the image display area
    const displayArea = document.querySelector('.image-display-area img')
    return displayArea
  }

  const downloadImage = async (format = 'png') => {
    if (!currentImageId) return
    
    try {
      const imgElement = getImageElement()
      if (!imgElement) {
        console.error("Image element not found")
        return
      }

      const canvas = canvasRef.current
      const ctx = canvas.getContext('2d')
      
      // Set canvas dimensions to match image
      canvas.width = imgElement.naturalWidth || imgElement.width
      canvas.height = imgElement.naturalHeight || imgElement.height
      
      // Draw image to canvas
      ctx.drawImage(imgElement, 0, 0)
      
      // Convert to blob and download
      canvas.toBlob((blob) => {
        if (blob) {
          const url = URL.createObjectURL(blob)
          const link = document.createElement('a')
          link.href = url
          link.download = `generated-image-${Date.now()}.${format}`
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
          URL.revokeObjectURL(url)
        }
      }, `image/${format}`, format === 'jpg' ? 0.95 : 1.0)
      
    } catch (error) {
      console.error("Download failed:", error)
    }
  }

  const copyToClipboard = async () => {
    if (!currentImageId) return
    
    try {
      const imgElement = getImageElement()
      if (!imgElement) {
        setCopyStatus("Error: Image not found")
        return
      }

      const canvas = canvasRef.current
      const ctx = canvas.getContext('2d')
      
      // Set canvas dimensions to match image
      canvas.width = imgElement.naturalWidth || imgElement.width
      canvas.height = imgElement.naturalHeight || imgElement.height
      
      // Draw image to canvas
      ctx.drawImage(imgElement, 0, 0)
      
      // Convert canvas to blob
      canvas.toBlob(async (blob) => {
        if (blob && navigator.clipboard && navigator.clipboard.write) {
          try {
            await navigator.clipboard.write([
              new ClipboardItem({ [blob.type]: blob })
            ])
            setCopyStatus("Copied!")
            setTimeout(() => setCopyStatus(""), 2000)
          } catch (error) {
            console.error("Clipboard write failed:", error)
            setCopyStatus("Copy failed")
            setTimeout(() => setCopyStatus(""), 2000)
          }
        } else {
          setCopyStatus("Clipboard not supported")
          setTimeout(() => setCopyStatus(""), 2000)
        }
      }, 'image/png')
      
    } catch (error) {
      console.error("Copy failed:", error)
      setCopyStatus("Copy failed")
      setTimeout(() => setCopyStatus(""), 2000)
    }
  }

  const randomizeSeed = () => {
    setSeed(Math.floor(Math.random() * 1000000).toString())
  }

  const applyStylePreset = (presetId) => {
    setSelectedStylePreset(presetId)
  }

  return (
    <div className={`min-h-screen transition-colors duration-300 ${theme.bg}`}>
      <div className="container mx-auto px-4 py-8">
        {/* Header */}
        <div className="flex justify-between items-center mb-8">
          <div>
            <h1 className={`text-4xl font-bold ${theme.text} mb-2`}>
              Salai AI Studio
            </h1>
            <p className={`${theme.textSecondary}`}>
              Professional image generation with advanced controls and style presets
            </p>
          </div>
          
          {/* Theme Toggle */}
          <button
            onClick={() => setIsDarkTheme(!isDarkTheme)}
            className={`px-4 py-2 rounded-lg border transition-colors ${theme.border} ${theme.buttonSecondary}`}
          >
            {isDarkTheme ? '‚òÄÔ∏è Light' : 'üåô Dark'}
          </button>
        </div>

        <div className="grid lg:grid-cols-3 gap-8">
          {/* Controls Panel */}
          <div className={`${theme.cardBg} ${theme.border} border rounded-lg p-6 ${theme.shadow}`}>
            <h2 className={`text-xl font-semibold ${theme.text} mb-6`}>
              Generation Settings
            </h2>
            
            {/* Prompt Input */}
            <div className="mb-6">
              <label className={`block ${theme.text} font-medium mb-2`}>
                Prompt
              </label>
              <textarea
                value={prompt}
                onChange={(e) => setPrompt(e.target.value)}
                className={`w-full p-3 rounded-lg border resize-none h-24 transition-colors ${theme.input}`}
                placeholder="Describe your image in detail..."
              />
            </div>

            {/* Style Presets */}
            <div className="mb-6">
              <label className={`block ${theme.text} font-medium mb-2`}>
                Style Preset
              </label>
              <select
                value={selectedStylePreset}
                onChange={(e) => applyStylePreset(e.target.value)}
                className={`w-full p-3 rounded-lg border transition-colors ${theme.input}`}
              >
                {stylePresets.map(preset => (
                  <option key={preset.id} value={preset.id}>
                    {preset.name}
                  </option>
                ))}
              </select>
            </div>

            {/* Model Selection */}
            <div className="mb-4">
              <label className={`block ${theme.text} font-medium mb-2`}>
                AI Model
              </label>
              <select
                value={selectedModel}
                onChange={(e) => setSelectedModel(e.target.value)}
                className={`w-full p-3 rounded-lg border transition-colors ${theme.input}`}
              >
                {models.map(model => (
                  <option key={model.id} value={model.id}>
                    {model.name} {model.free ? "üÜì" : "üíé"}
                  </option>
                ))}
              </select>
            </div>

            {/* Size Selection */}
            <div className="mb-4">
              <label className={`block ${theme.text} font-medium mb-2`}>
                Image Size
              </label>
              <select
                value={imageSize}
                onChange={(e) => setImageSize(e.target.value)}
                className={`w-full p-3 rounded-lg border transition-colors ${theme.input}`}
              >
                {sizes.map(size => (
                  <option key={size.id} value={size.id}>
                    {size.name}
                  </option>
                ))}
              </select>
            </div>

            {/* Seed Controls */}
            <div className="mb-4">
              <label className={`block ${theme.text} font-medium mb-2`}>
                Seed (Optional)
              </label>
              <div className="flex gap-2">
                <input
                  type="text"
                  value={seed}
                  onChange={(e) => setSeed(e.target.value)}
                  className={`flex-1 p-3 rounded-lg border transition-colors ${theme.input}`}
                  placeholder="Random seed..."
                />
                <button
                  onClick={randomizeSeed}
                  className={`px-4 py-3 rounded-lg transition-colors ${theme.buttonSecondary}`}
                >
                  üé≤
                </button>
              </div>
            </div>

            {/* Safety Toggle */}
            <div className="mb-6">
              <label className={`flex items-center gap-3 ${theme.text} font-medium cursor-pointer`}>
                <input
                  type="checkbox"
                  checked={enableSafety}
                  onChange={(e) => setEnableSafety(e.target.checked)}
                  className="w-4 h-4 text-blue-600 rounded"
                />
                Enable Safety Filter
              </label>
            </div>

            {/* Generate Button */}
            <button
              onClick={generateImage}
              disabled={isGenerating || !prompt.trim()}
              className={`w-full py-4 text-white font-semibold rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed ${theme.button}`}
            >
              {isGenerating ? "Generating..." : "Generate Image"}
            </button>
          </div>

          {/* Image Display */}
          <div className={`${theme.cardBg} ${theme.border} border rounded-lg p-6 ${theme.shadow}`}>
            <h2 className={`text-xl font-semibold ${theme.text} mb-6`}>
              Generated Image
            </h2>
            
            {currentImageId ? (
              <div className="space-y-4">
                <div className={`border rounded-lg p-2 image-display-area ${theme.border}`}>
                  <div data-image-id={currentImageId}>
                    <ImgGen 
                      _id={currentImageId} 
                      database={database}
                      className="w-full h-auto rounded"
                      ref={imageRef}
                    />
                  </div>
                </div>
                
                {/* Action Buttons */}
                <div className="grid grid-cols-2 gap-2">
                  <button
                    onClick={copyToClipboard}
                    className={`py-2 px-4 rounded-lg transition-colors ${copyStatus === "Copied!" ? 'bg-green-500 text-white' : theme.buttonSecondary}`}
                  >
                    {copyStatus || "Copy to Clipboard"}
                  </button>
                  <button
                    onClick={() => downloadImage('png')}
                    className={`py-2 px-4 rounded-lg transition-colors ${theme.buttonSecondary}`}
                  >
                    Download PNG
                  </button>
                  <button
                    onClick={() => downloadImage('jpg')}
                    className={`py-2 px-4 rounded-lg transition-colors ${theme.buttonSecondary}`}
                  >
                    Download JPG
                  </button>
                  <button
                    onClick={() => setCurrentImageId(null)}
                    className="py-2 px-4 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
                  >
                    Clear
                  </button>
                </div>
              </div>
            ) : (
              <div className={`border-2 border-dashed rounded-lg p-12 text-center ${theme.border}`}>
                <div className="text-4xl mb-4">üé®</div>
                <p className={`${theme.textSecondary} font-medium`}>
                  Your generated image will appear here
                </p>
              </div>
            )}
          </div>

          {/* Gallery */}
          <div className={`${theme.cardBg} ${theme.border} border rounded-lg p-6 ${theme.shadow}`}>
            <h2 className={`text-xl font-semibold ${theme.text} mb-6`}>
              Recent Images
            </h2>
            
            {imageDocuments.length > 0 ? (
              <div className="space-y-3 max-h-96 overflow-y-auto">
                {imageDocuments.slice(0, 10).map((doc) => (
                  <div 
                    key={doc._id}
                    className={`border rounded-lg p-3 cursor-pointer transition-all hover:shadow-md ${theme.border}`}
                    onClick={() => setCurrentImageId(doc._id)}
                  >
                    <div className="flex gap-3">
                      <div className="w-16 h-16 flex-shrink-0">
                        <ImgGen 
                          _id={doc._id} 
                          database={database}
                          className="w-full h-full object-cover rounded"
                        />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className={`text-sm font-medium ${theme.text} truncate`}>
                          {doc.originalPrompt || doc.prompt}
                        </p>
                        {doc.stylePreset && (
                          <p className={`text-xs ${theme.textSecondary} mt-1`}>
                            Style: {stylePresets.find(p => p.id === doc.stylePreset)?.name}
                          </p>
                        )}
                        <p className={`text-xs ${theme.textSecondary} mt-1`}>
                          {new Date(doc.createdAt).toLocaleDateString()}
                        </p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8">
                <div className="text-3xl mb-3">üì∏</div>
                <p className={`${theme.textSecondary}`}>
                  No images generated yet
                </p>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Hidden canvas for image processing */}
      <canvas ref={canvasRef} className="hidden" />
    </div>
  )
}
      // prettier-ignore-end

      const rootElement = document.getElementById("container");
      ReactDOMClient.createRoot(rootElement).render(<App />);
    </script>
    <!--
    Agents see LLMs docs:
      Database: https://use-fireproof.com/llms-full.txt 
      CallAI: https://use-fireproof.com/callai-llms.txt
      ImgGen: https://use-fireproof.com/imggen-llms.txt
    -->
  </body>
</html>
